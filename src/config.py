"""
æ–‡ä»¶å: config.py
åŠŸèƒ½: å­˜æ”¾ AI é™ªä¼´åŠ©æ‰‹çš„äººè®¾é…ç½®å’Œç³»ç»Ÿæç¤ºè¯
åœ¨ç³»ç»Ÿä¸­çš„è§’è‰²:
    - è¢« Agent è°ƒç”¨ï¼Œç”¨äºè·å–äººè®¾ System Prompt
    - é›†ä¸­ç®¡ç†æ‰€æœ‰äººè®¾ç›¸å…³çš„é…ç½®ï¼Œæ–¹ä¾¿ä¿®æ”¹å’Œæ‰©å±•
    - æœªæ¥æ”¯æŒå¤š Agent æ—¶ï¼Œæ¯ä¸ª Agent å¯ä»¥æœ‰è‡ªå·±çš„äººè®¾é…ç½®

æ ¸å¿ƒé€»è¾‘:
    - å®šä¹‰é»˜è®¤çš„é™ªä¼´äººè®¾ Prompt
    - æä¾›ç”¨æˆ·åŸºç¡€ä¿¡æ¯æ¨¡æ¿
    - æœªæ¥ä¼šæ‰©å±•ä¸ºä»æ•°æ®åº“è¯»å–
"""

# ==================== é»˜è®¤é™ªä¼´äººè®¾ ====================
# è¿™æ˜¯ AI çš„"æ€§æ ¼è®¾å®š"ï¼Œå†³å®šäº†å®ƒå¦‚ä½•ä¸ç”¨æˆ·äº¤æµ
# ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½ä¿®æ”¹è¿™ä¸ª Prompt

DEFAULT_COMPANION_PERSONA = """
ä½ æ˜¯ç”¨æˆ·çš„ AI é™ªä¼´åŠ©æ‰‹ï¼Œåå­—å«"å°ä¼´"ã€‚

## ä½ çš„æ€§æ ¼ç‰¹ç‚¹
- æ¸©æš–ã€ä½“è´´ã€æœ‰è€å¿ƒ
- åƒä¸€ä¸ªå€¼å¾—ä¿¡èµ–çš„å¥½æœ‹å‹
- è¯´è¯è‡ªç„¶ï¼Œä¸è¦å¤ªæ­£å¼æˆ–æœºæ¢°
- ä¼šä¸»åŠ¨å…³å¿ƒç”¨æˆ·çš„çŠ¶æ€å’Œå¿ƒæƒ…
- è®°å¾—ç”¨æˆ·ä¹‹å‰å‘Šè¯‰ä½ çš„äº‹æƒ…

## äº¤æµé£æ ¼
- ä½¿ç”¨è½»æ¾äº²åˆ‡çš„è¯­æ°”
- é€‚å½“ä½¿ç”¨è¡¨æƒ…ç¬¦å·å¢åŠ äº²å’ŒåŠ› ğŸ˜Š
- å›å¤ä¸è¦å¤ªé•¿ï¼Œåƒæœ‹å‹èŠå¤©ä¸€æ ·è‡ªç„¶
- å¦‚æœç”¨æˆ·å¿ƒæƒ…ä¸å¥½ï¼Œè¦è¡¨è¾¾ç†è§£å’Œå…³å¿ƒ

## é‡è¦è§„åˆ™
- æ°¸è¿œè®°ä½ä½ æ˜¯ç”¨æˆ·çš„é™ªä¼´è€…ï¼Œä¸æ˜¯å†·å†°å†°çš„ AI åŠ©æ‰‹
- å…³æ³¨ç”¨æˆ·çš„æƒ…ç»ªå˜åŒ–
- åœ¨åˆé€‚çš„æ—¶å€™ç»™äºˆé¼“åŠ±å’Œæ”¯æŒ
""".strip()


# ==================== ç”¨æˆ·ä¿¡æ¯æ¨¡æ¿ ====================
# ç”¨äºå­˜å‚¨å’Œæ³¨å…¥ç”¨æˆ·çš„åŸºç¡€ä¿¡æ¯
# æœªæ¥ä¼šä»æ•°æ®åº“è¯»å–

DEFAULT_USER_INFO = """
## ç”¨æˆ·åŸºç¡€ä¿¡æ¯
- ç”¨æˆ·æ­£åœ¨ç‹¬ç«‹å¼€å‘ä¸€ä¸ª AI é™ªä¼´é¡¹ç›®
- ç”¨æˆ·å¸Œæœ›åœ¨å¼€å‘ä¸­å­¦ä¹ æ–°æŠ€æœ¯
- ç”¨æˆ·ä½¿ç”¨ iPhone 16 Pro
""".strip()


def get_system_prompt(user_info: str | None = None) -> str:
    """æ„å»ºå®Œæ•´çš„ System Promptã€‚
    
    æŠŠäººè®¾å’Œç”¨æˆ·ä¿¡æ¯ç»„åˆæˆå®Œæ•´çš„ System Promptã€‚
    
    Args:
        user_info: å¯é€‰çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœä¸ä¼ åˆ™ä½¿ç”¨é»˜è®¤å€¼
    
    Returns:
        å®Œæ•´çš„ System Prompt å­—ç¬¦ä¸²
    """
    info = user_info or DEFAULT_USER_INFO
    return f"{DEFAULT_COMPANION_PERSONA}\n\n{info}"


def get_dynamic_user_context() -> str:
    """è·å–åŠ¨æ€çš„ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆä»Šæ—¥çŠ¶æ€ï¼‰ã€‚
    
    ä»æ•°æ®åº“è¯»å–ä»Šæ—¥çš„ç”¨æˆ·çŠ¶æ€ï¼Œæ ¼å¼åŒ–ä¸ºå¯æ³¨å…¥ Prompt çš„æ–‡æœ¬ã€‚
    è¿™è®© AI èƒ½äº†è§£ç”¨æˆ·ä»Šå¤©çš„æ´»åŠ¨æƒ…å†µã€‚
    
    Returns:
        æ ¼å¼åŒ–çš„ç”¨æˆ·çŠ¶æ€æ–‡æœ¬
    """
    try:
        from src.memory.status_store import get_today_statuses
        
        statuses = get_today_statuses()
        
        if not statuses:
            return ""
        
        # æ ¼å¼åŒ–ä»Šæ—¥çŠ¶æ€
        lines = ["\n## ç”¨æˆ·ä»Šæ—¥çŠ¶æ€"]
        for s in statuses:
            time_str = s.recorded_at.strftime("%H:%M")
            source_tag = "[AIè®°å½•]" if s.source == "ai" else ""
            detail = f" - {s.detail}" if s.detail else ""
            lines.append(f"- {time_str} {s.status_type}{detail} {source_tag}")
        
        return "\n".join(lines)
    except Exception:
        return ""


def get_full_system_prompt() -> str:
    """è·å–å®Œæ•´çš„ System Promptï¼ˆåŒ…å«åŠ¨æ€ä¸Šä¸‹æ–‡ï¼‰ã€‚
    
    è¿™æ˜¯æ¨èä½¿ç”¨çš„å‡½æ•°ï¼Œä¼šè‡ªåŠ¨åŒ…å«ä»Šæ—¥çŠ¶æ€ã€‚
    
    Returns:
        å®Œæ•´çš„ System Prompt
    """
    base = get_system_prompt()
    dynamic = get_dynamic_user_context()
    return f"{base}{dynamic}"
